<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sora2 创作中心 - 多任务并发版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .loading-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .progress-fill { transition: width 0.5s ease-in-out; }
        .task-card { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

    <header class="bg-slate-900 p-4 text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold"><i class="fas fa-video mr-2 text-orange-500"></i>Sora2 创作中心</h1>
            <div class="text-[10px] bg-slate-700 px-3 py-1 rounded-full flex items-center border border-slate-600">
                <i class="fas fa-bolt mr-1 text-yellow-400"></i> 多任务并发模式
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 lg:p-6 grid grid-cols-1 lg:grid-cols-12 gap-6">
        <section class="lg:col-span-3 space-y-4">
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200">
                <div class="flex justify-between items-center mb-3">
                    <h2 class="font-bold text-gray-700 text-sm">角色库</h2>
                    <button onclick="toggleAddChar()" class="text-orange-600 text-xs font-bold hover:bg-orange-50 px-2 py-1 rounded transition">+ 新增</button>
                </div>
                <div id="charList" class="grid grid-cols-2 gap-2 max-h-[400px] overflow-y-auto pr-1"></div>
                
                <div id="addCharForm" class="hidden border-t mt-3 pt-3 space-y-2">
                    <input type="text" id="newCharId" placeholder="ID (如: Lily)" class="w-full p-2 border rounded text-xs bg-gray-50 focus:bg-white outline-none focus:border-orange-500">
                    <div class="relative group">
                        <input type="file" id="newCharImg" accept="image/*" class="block w-full text-xs text-slate-500 file:mr-2 file:py-1 file:px-2 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-orange-50 file:text-orange-700 hover:file:bg-orange-100 cursor-pointer">
                    </div>
                    <button onclick="saveCharToLocal()" class="w-full bg-slate-800 hover:bg-slate-900 text-white py-1.5 rounded text-xs font-bold transition">保存角色</button>
                </div>
            </div>
            <button onclick="clearCache()" class="w-full text-[10px] text-gray-400 hover:text-red-500 text-center py-2">清空所有缓存数据</button>
        </section>

        <section class="lg:col-span-5 space-y-4">
            <div class="bg-white p-5 rounded-xl shadow-lg border border-gray-100 ring-1 ring-gray-100">
                <div class="space-y-4">
                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase tracking-wider">API Key</label>
                        <input type="password" id="apiKey" placeholder="在此粘贴您的 Bearer Token" class="w-full p-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:bg-white outline-none transition-all">
                    </div>

                    <div>
                        <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase tracking-wider">提示词 Prompt</label>
                        <textarea id="prompt" rows="5" class="w-full p-3 bg-gray-50 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-orange-500 focus:bg-white outline-none transition-all resize-none" placeholder="描述你的画面... (点击左侧角色可快速插入)"></textarea>
                    </div>

                    <div class="relative">
                        <label class="block text-[10px] font-bold text-gray-400 mb-1 uppercase tracking-wider">参考底图 (可选)</label>
                        <div id="uploadZone" class="border-2 border-dashed border-gray-200 rounded-lg p-3 text-center cursor-pointer hover:border-orange-400 hover:bg-orange-50 transition-colors group">
                            <input type="file" id="refInput" accept="image/*" class="hidden" onchange="handleRefSelect(event)">
                            <label for="refInput" class="cursor-pointer block">
                                <i class="fas fa-cloud-upload-alt text-gray-300 group-hover:text-orange-500 text-xl mb-1"></i>
                                <div class="text-xs text-gray-400 group-hover:text-orange-600">点击上传参考图</div>
                            </label>
                        </div>
                        <div id="previewZone" class="hidden flex items-center bg-orange-50 border border-orange-100 rounded-lg p-2 mt-2">
                            <img id="refPreview" src="" class="w-10 h-10 rounded object-cover border border-white shadow-sm">
                            <div class="ml-3 flex-1 min-w-0">
                                <p class="text-xs font-bold text-orange-800 truncate">参考图已就绪</p>
                                <p class="text-[10px] text-orange-600/70 truncate">将在下次生成时使用</p>
                            </div>
                            <button onclick="clearRef()" class="text-gray-400 hover:text-red-500 p-2"><i class="fas fa-times"></i></button>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <select id="aspectRatio" class="p-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm outline-none focus:border-orange-500">
                            <option value="16:9">宽屏 16:9</option>
                            <option value="9:16">竖屏 9:16</option>
                            <option value="1:1">方形 1:1</option>
                        </select>
                        <select id="duration" class="p-2.5 bg-gray-50 border border-gray-200 rounded-lg text-sm outline-none focus:border-orange-500">
                            <option value="5">5秒视频</option>
                            <option value="10" selected>10秒视频</option>
                        </select>
                    </div>

                    <button id="submitBtn" onclick="submitTask()" class="w-full bg-gradient-to-r from-slate-800 to-slate-900 hover:from-orange-600 hover:to-orange-700 text-white font-bold py-3.5 rounded-xl shadow-lg hover:shadow-xl hover:-translate-y-0.5 transition-all duration-200 flex justify-center items-center group">
                        <span id="btnText">立即生成视频</span>
                        <i id="btnIcon" class="fas fa-paper-plane ml-2 group-hover:translate-x-1 transition-transform"></i>
                    </button>
                </div>
            </div>
        </section>

        <section class="lg:col-span-4 h-full">
            <div class="flex items-center justify-between mb-3">
                <h2 class="text-xs font-bold text-gray-400 uppercase tracking-widest">任务列表</h2>
                <span class="text-[10px] bg-green-100 text-green-700 px-2 py-0.5 rounded-full border border-green-200">实时更新中</span>
            </div>
            <div id="taskContainer" class="space-y-3 pb-10">
                </div>
        </section>
    </main>

<script>
    // ================= 配置与初始化 =================
    const API_HOST = "https://grsaiapi.com";
    let currentRefBase64 = null;
    
    // 初始化加载
    document.addEventListener('DOMContentLoaded', () => {
        loadChars();
        loadHistory();
    });

    // ================= 核心逻辑：提交与并发处理 =================
    
    // 1. 提交任务 (包含防卡死逻辑)
    async function submitTask() {
        const btn = document.getElementById('submitBtn');
        const btnText = document.getElementById('btnText');
        const btnIcon = document.getElementById('btnIcon');
        
        // 获取参数
        const prompt = document.getElementById('prompt').value.trim();
        const key = document.getElementById('apiKey').value.trim();
        if(!prompt || !key) return alert("请填写 API Key 和 提示词");

        // --- 锁定按钮状态 ---
        btn.disabled = true;
        btn.classList.add('opacity-75', 'cursor-wait');
        btnText.innerText = "提交请求中...";
        btnIcon.className = "fas fa-circle-notch loading-spin ml-2";

        // 创建本地UI卡片 (立即反馈)
        const uiId = 'job-' + Date.now();
        createTaskCard(uiId, prompt);

        try {
            // 构建 Payload
            const payload = {
                model: "sora-2",
                prompt: prompt,
                aspectRatio: document.getElementById('aspectRatio').value,
                duration: parseInt(document.getElementById('duration').value)
            };
            if(currentRefBase64) payload.reference_image = currentRefBase64;

            // 发送请求
            const resp = await fetch(`${API_HOST}/v1/video/sora-video`, {
                method: 'POST',
                headers: { 
                    'Authorization': `Bearer ${key}`, 
                    'Content-Type': 'application/json' 
                },
                body: JSON.stringify(payload)
            });

            const data = await parseResponse(resp);

            if(!resp.ok) throw new Error(data?.msg || "服务器返回错误");
            const taskId = data.data?.id || data.id;
            
            if(!taskId) throw new Error("未获得任务ID");

            // --- 提交成功 ---
            updateCardStatus(uiId, { msg: "排队中...", progress: 5 });
            
            // 启动后台独立轮询 (不阻塞主线程)
            startPolling(taskId, uiId, key, prompt);
            
            // 清理参考图 (防止下一次误用)
            clearRef();

        } catch (err) {
            console.error(err);
            updateCardStatus(uiId, { msg: "提交失败: " + err.message, type: 'error' });
        } finally {
            // --- 关键修正：无论成功失败，必须立刻解锁按钮 ---
            // 延时200毫秒稍微给一点视觉反馈，然后立刻恢复
            setTimeout(() => {
                btn.disabled = false;
                btn.classList.remove('opacity-75', 'cursor-wait');
                btnText.innerText = "立即生成视频";
                btnIcon.className = "fas fa-paper-plane ml-2";
            }, 300);
        }
    }

    // 2. 独立轮询 (每个任务通过闭包拥有独立的定时器)
    function startPolling(taskId, uiId, key, originalPrompt) {
        let errorCount = 0;
        
        const timer = setInterval(async () => {
            try {
                const resp = await fetch(`${API_HOST}/v1/draw/result`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${key}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: taskId })
                });
                
                const res = await parseResponse(resp);
                if(!res || !res.data) return;

                const { status, progress, results, url, failure_reason } = res.data;
                const safeProgress = Math.min(99, parseInt(progress) || 0);

                if (status === 'succeeded' || status === 'success') {
                    clearInterval(timer); // 停止轮询
                    const videoUrl = results?.[0]?.url || url || (Array.isArray(results) ? results[0] : null);
                    
                    if(videoUrl) {
                        updateCardStatus(uiId, { msg: "生成完成", progress: 100, type: 'success' });
                        renderVideoResult(uiId, videoUrl);
                        saveToHistory(originalPrompt, videoUrl); // 保存历史
                    } else {
                        updateCardStatus(uiId, { msg: "成功但无视频地址", type: 'error' });
                    }
                } else if (status === 'failed') {
                    clearInterval(timer);
                    updateCardStatus(uiId, { msg: "生成失败: " + (failure_reason || "未知原因"), type: 'error' });
                } else {
                    // 正在运行
                    updateCardStatus(uiId, { 
                        msg: safeProgress > 0 ? `生成中 ${safeProgress}%` : `等待资源分配...`, 
                        progress: safeProgress 
                    });
                }
            } catch (e) {
                errorCount++;
                if(errorCount > 20) { // 连续错误60秒才停止
                    clearInterval(timer);
                    updateCardStatus(uiId, { msg: "网络连接中断", type: 'error' });
                }
            }
        }, 3000); // 每3秒轮询一次
    }

    // ================= UI 渲染函数 =================
    
    function createTaskCard(id, prompt) {
        const html = `
            <div id="${id}" class="task-card bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                <div class="p-3 border-b border-gray-50 flex justify-between items-start bg-gray-50/50">
                    <p class="text-xs text-gray-600 line-clamp-2 flex-1 font-medium" title="${prompt}">${prompt}</p>
                    <button onclick="removeCard('${id}')" class="text-gray-300 hover:text-red-400 ml-2"><i class="fas fa-times text-xs"></i></button>
                </div>
                <div class="p-3">
                    <div class="status-row flex justify-between text-[10px] font-bold text-slate-500 mb-1.5">
                        <span class="status-msg"><i class="fas fa-circle-notch loading-spin mr-1 text-orange-500"></i>准备中...</span>
                        <span class="status-pct">0%</span>
                    </div>
                    <div class="w-full bg-gray-100 h-1.5 rounded-full overflow-hidden">
                        <div class="progress-bar bg-orange-500 h-full w-0 progress-fill"></div>
                    </div>
                    <div class="video-container hidden mt-3 rounded-lg overflow-hidden bg-black relative group">
                        </div>
                </div>
            </div>
        `;
        const container = document.getElementById('taskContainer');
        container.insertAdjacentHTML('afterbegin', html);
    }

    function updateCardStatus(id, { msg, progress, type }) {
        const card = document.getElementById(id);
        if(!card) return;

        const msgEl = card.querySelector('.status-msg');
        const pctEl = card.querySelector('.status-pct');
        const barEl = card.querySelector('.progress-bar');
        const icon = card.querySelector('.loading-spin');

        if(msg) msgEl.innerHTML = (type === 'loading' || !type ? `<i class="fas fa-circle-notch loading-spin mr-1 text-orange-500"></i>` : ``) + msg;
        if(progress !== undefined) {
            barEl.style.width = `${progress}%`;
            pctEl.innerText = `${progress}%`;
        }

        if(type === 'success') {
            msgEl.className = 'status-msg text-green-600';
            msgEl.innerHTML = `<i class="fas fa-check-circle mr-1"></i>完成`;
            barEl.className = 'progress-bar bg-green-500 h-full w-full';
            if(icon) icon.remove();
        } else if(type === 'error') {
            msgEl.className = 'status-msg text-red-500';
            barEl.className = 'progress-bar bg-red-500 h-full w-full';
            if(icon) icon.remove();
        }
    }

    function renderVideoResult(id, url) {
        const card = document.getElementById(id);
        if(!card) return;
        const container = card.querySelector('.video-container');
        container.innerHTML = `
            <video src="${url}" controls class="w-full h-auto max-h-[200px] object-contain"></video>
            <a href="${url}" target="_blank" class="absolute top-2 right-2 bg-black/60 text-white p-1.5 rounded hover:bg-black text-[10px] opacity-0 group-hover:opacity-100 transition"><i class="fas fa-external-link-alt"></i></a>
        `;
        container.classList.remove('hidden');
    }
    
    function removeCard(id) {
        document.getElementById(id).remove();
    }

    // ================= 辅助功能：角色、参考图、历史 =================
    
    // 角色管理
    function loadChars() {
        const chars = JSON.parse(localStorage.getItem('sora_chars') || '[]');
        const list = document.getElementById('charList');
        if(chars.length === 0) {
            list.innerHTML = `<div class="col-span-2 text-[10px] text-gray-400 text-center py-4 border border-dashed rounded bg-gray-50">暂无角色</div>`;
            return;
        }
        list.innerHTML = chars.map((c, i) => `
            <div class="flex items-center p-1.5 border rounded-lg hover:border-orange-400 cursor-pointer bg-white group transition" onclick="insertPrompt('@${c.id}')">
                <img src="${c.avatar}" class="w-8 h-8 rounded object-cover border border-gray-100">
                <span class="ml-2 text-xs font-bold text-gray-700 truncate flex-1">@${c.id}</span>
                <button onclick="delChar(event, ${i})" class="text-gray-300 hover:text-red-500 px-1 opacity-0 group-hover:opacity-100"><i class="fas fa-times"></i></button>
            </div>
        `).join('');
    }
    
    function saveCharToLocal() {
        const id = document.getElementById('newCharId').value.trim();
        const file = document.getElementById('newCharImg').files[0];
        if(!id || !file) return alert("请填写ID并上传图片");
        
        // 压缩图片防止 LocalStorage 溢出
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = new Image();
            img.src = e.target.result;
            img.onload = () => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const max = 150; 
                let w = img.width, h = img.height;
                if(w>h){if(w>max){h*=max/w;w=max;}}else{if(h>max){w*=max/h;h=max;}}
                canvas.width=w; canvas.height=h;
                ctx.drawImage(img,0,0,w,h);
                
                const chars = JSON.parse(localStorage.getItem('sora_chars') || '[]');
                chars.push({id, avatar: canvas.toDataURL('image/jpeg', 0.7)});
                localStorage.setItem('sora_chars', JSON.stringify(chars));
                loadChars(); toggleAddChar();
            }
        };
        reader.readAsDataURL(file);
    }
    
    function delChar(e, i) {
        e.stopPropagation();
        const chars = JSON.parse(localStorage.getItem('sora_chars') || '[]');
        chars.splice(i, 1);
        localStorage.setItem('sora_chars', JSON.stringify(chars));
        loadChars();
    }

    // 参考图逻辑
    function handleRefSelect(e) {
        const file = e.target.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            currentRefBase64 = ev.target.result;
            document.getElementById('refPreview').src = currentRefBase64;
            document.getElementById('uploadZone').classList.add('hidden');
            document.getElementById('previewZone').classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    }
    function clearRef() {
        currentRefBase64 = null;
        document.getElementById('refInput').value = '';
        document.getElementById('uploadZone').classList.remove('hidden');
        document.getElementById('previewZone').classList.add('hidden');
    }

    // 通用辅助
    function toggleAddChar() { document.getElementById('addCharForm').classList.toggle('hidden'); }
    function insertPrompt(txt) { document.getElementById('prompt').value += ` ${txt} `; }
    function clearCache() { if(confirm("确定清空？")) { localStorage.clear(); location.reload(); } }
    
    // 历史记录（仅显示，不主动轮询，防止API滥用）
    function loadHistory() {
        const hist = JSON.parse(localStorage.getItem('sora_history') || '[]');
        hist.forEach(h => {
            if(!document.getElementById(h.uiId)) {
                createTaskCard(h.uiId, h.prompt);
                updateCardStatus(h.uiId, { msg: "历史记录", progress: 100, type: 'success' });
                renderVideoResult(h.uiId, h.url);
            }
        });
    }
    function saveToHistory(prompt, url) {
        const hist = JSON.parse(localStorage.getItem('sora_history') || '[]');
        hist.unshift({ uiId: 'hist-'+Date.now(), prompt, url });
        if(hist.length > 20) hist.pop();
        localStorage.setItem('sora_history', JSON.stringify(hist));
    }

    // 解析工具 (处理 JSON 和 SSE)
    async function parseResponse(response) {
        const text = await response.text();
        try { return JSON.parse(text); } catch(e) {}
        // 尝试解析 SSE 格式
        const lines = text.split('\n');
        for(let line of lines) {
            if(line.startsWith('data:')) {
                try { return JSON.parse(line.substring(5).trim()); } catch(e) {}
            }
        }
        return {};
    }
</script>
</body>
</html>
