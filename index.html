<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sora2 创作中心 - 极速稳定版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .loading-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .progress-fill { transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1); }
        .history-item { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

    <header class="bg-orange-600 p-4 text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold"><i class="fas fa-video mr-2"></i>Sora2 创作中心</h1>
            <div class="text-[10px] bg-orange-800 px-2 py-1 rounded flex items-center">
                <i class="fas fa-cloud mr-1"></i> 云端部署已就绪
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 lg:p-8 grid grid-cols-1 lg:grid-cols-12 gap-8">
        <section class="lg:col-span-3 space-y-4">
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-bold text-gray-700">常用角色</h2>
                    <button onclick="toggleAddChar()" class="text-orange-600 text-sm font-bold">+ 新增</button>
                </div>
                <div id="charList" class="grid grid-cols-2 gap-3 mb-4 min-h-[50px]"></div>
                
                <div id="addCharForm" class="hidden border-t pt-4 space-y-3">
                    <input type="text" id="newCharId" placeholder="角色ID" class="w-full p-2 border rounded text-sm outline-none">
                    <input type="file" id="newCharImg" accept="image/*" class="w-full text-xs">
                    <button onclick="saveCharToLocal()" class="w-full bg-orange-600 text-white py-2 rounded text-sm font-bold">保存</button>
                </div>
            </div>
            <button onclick="clearHistory()" class="w-full text-xs text-gray-400 hover:text-red-500 transition-colors">清空本地存储</button>
        </section>

        <section class="lg:col-span-5 space-y-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-400 mb-2 uppercase">API KEY (Bearer Token)</label>
                    <input type="password" id="apiKey" placeholder="输入您的 Key" class="w-full p-3 border rounded-xl text-sm outline-none focus:ring-2 focus:ring-orange-500">
                </div>
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-400 mb-2 uppercase">提示词</label>
                    <textarea id="prompt" rows="6" class="w-full p-4 border rounded-xl text-sm outline-none focus:ring-2 focus:ring-orange-500 resize-none" placeholder="描述场景..."></textarea>
                </div>

                <div class="mb-6">
                    <label class="block text-xs font-bold text-gray-400 mb-2 uppercase">参考底图 (可选)</label>
                    <div id="refUpload" class="flex items-center justify-center w-full">
                        <label class="flex flex-col items-center justify-center w-full h-16 border-2 border-dashed rounded-xl cursor-pointer bg-gray-50 hover:bg-gray-100 transition-all">
                            <span class="text-xs text-gray-400"><i class="fas fa-image mr-2"></i>点击上传</span>
                            <input type="file" id="refInput" accept="image/*" class="hidden" onchange="handleRefSelect(event)">
                        </label>
                    </div>
                    <div id="refPreviewArea" class="hidden mt-2 p-2 border rounded-xl bg-orange-50 relative">
                        <div class="flex items-center">
                            <img id="refPreviewImg" src="" class="w-12 h-12 object-cover rounded shadow-sm">
                            <span class="ml-2 text-xs text-orange-600 font-bold">已就绪</span>
                        </div>
                        <button onclick="clearRef()" class="absolute top-1 right-1 text-gray-400 hover:text-red-500">×</button>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-6">
                    <select id="aspectRatio" class="p-3 border rounded-xl text-sm bg-white">
                        <option value="16:9">横屏 16:9</option>
                        <option value="9:16">竖屏 9:16</option>
                    </select>
                    <select id="duration" class="p-3 border rounded-xl text-sm bg-white">
                        <option value="10" selected>10s</option>
                        <option value="15">15s</option>
                    </select>
                </div>
                <button onclick="startRender()" id="renderBtn" class="w-full bg-slate-900 hover:bg-black text-white font-bold py-4 rounded-2xl shadow-xl transition-all">
                    <span id="btnText">开始生成</span>
                </button>
            </div>
        </section>

        <section class="lg:col-span-4">
            <h2 class="text-xs font-bold text-gray-400 mb-4 uppercase tracking-widest">任务状态与历史</h2>
            <div id="taskQueue" class="space-y-4"></div>
        </section>
    </main>

<script>
    const API_HOST = "https://grsaiapi.com";
    let myCharacters = JSON.parse(localStorage.getItem('sora_chars') || '[]');
    let videoHistory = JSON.parse(localStorage.getItem('sora_hist') || '[]');
    let currentRefBase64 = null;
    let isRendering = false;

    // 初始化
    window.onload = () => { renderCharacters(); renderHistory(); };

    // --- 图片处理 ---
    function handleRefSelect(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
            currentRefBase64 = ev.target.result;
            document.getElementById('refPreviewImg').src = currentRefBase64;
            document.getElementById('refUpload').classList.add('hidden');
            document.getElementById('refPreviewArea').classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    }

    function clearRef() {
        currentRefBase64 = null;
        document.getElementById('refUpload').classList.remove('hidden');
        document.getElementById('refPreviewArea').classList.add('hidden');
    }

    // --- 角色管理 ---
    function toggleAddChar() { document.getElementById('addCharForm').classList.toggle('hidden'); }
    function insertChar(id) { document.getElementById('prompt').value += ` @${id} `; }
    function renderCharacters() {
        document.getElementById('charList').innerHTML = myCharacters.map((c, i) => `
            <div class="relative group border rounded-xl p-2 text-center bg-white cursor-pointer" onclick="insertChar('${c.id}')">
                <img src="${c.avatar}" class="w-full aspect-square rounded-lg object-cover mb-1">
                <div class="text-[10px] font-bold">@${c.id}</div>
                <button onclick="deleteChar(event, ${i})" class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-4 h-4 text-[10px]">×</button>
            </div>`).join('');
    }
    function saveCharToLocal() {
        const id = document.getElementById('newCharId').value.trim();
        const file = document.getElementById('newCharImg').files[0];
        if(!id || !file) return alert("请完善信息");
        const reader = new FileReader();
        reader.onload = (e) => {
            myCharacters.push({ id, avatar: e.target.result });
            localStorage.setItem('sora_chars', JSON.stringify(myCharacters));
            renderCharacters(); toggleAddChar();
        };
        reader.readAsDataURL(file);
    }
    function deleteChar(e, i) { e.stopPropagation(); myCharacters.splice(i, 1); localStorage.setItem('sora_chars', JSON.stringify(myCharacters)); renderCharacters(); }

    // --- 核心生成逻辑 ---
    async function startRender() {
        if (isRendering) return;
        const promptText = document.getElementById('prompt').value.trim();
        const key = document.getElementById('apiKey').value.trim();
        if (!promptText || !key) return alert("缺少必要参数");

        setBtnLoading(true);
        const uiId = 'task-' + Date.now();
        createTaskCard(uiId, promptText);

        try {
            const payload = {
                model: "sora-2", prompt: promptText,
                aspectRatio: document.getElementById('aspectRatio').value,
                duration: parseInt(document.getElementById('duration').value)
            };
            if (currentRefBase64) payload.reference_image = currentRefBase64;

            const resp = await fetch(`${API_HOST}/v1/video/sora-video`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${key}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await parseStream(resp);
            // 提交成功后立即允许下一次点击
            setBtnLoading(false);
            clearRef();

            if (!resp.ok) throw new Error(data?.msg || "提交失败");
            const taskId = data.data?.id || data.id;

            updateStatus(uiId, "队列中...", 5);
            pollStatus(taskId, uiId, key, promptText);

        } catch (e) {
            setBtnLoading(false);
            updateStatus(uiId, "错误: " + e.message, 0, 'error');
        }
    }

    async function pollStatus(taskId, uiId, key, prompt) {
        const timer = setInterval(async () => {
            try {
                const resp = await fetch(`${API_HOST}/v1/draw/result`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${key}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: taskId })
                });
                const res = await parseStream(resp);
                if (!res || !res.data) return;

                const { status, progress, results, url } = res.data; // 对接 API 文档字段
                const curProgress = parseInt(progress) || 0;

                if (status === 'succeeded' || status === 'success') {
                    clearInterval(timer);
                    const finalUrl = results?.[0]?.url || url;
                    saveHist(prompt, finalUrl);
                    showVideo(uiId, finalUrl);
                } else if (status === 'failed') {
                    clearInterval(timer);
                    updateStatus(uiId, "失败: " + (res.data.failure_reason || "被拦截"), 0, 'error');
                } else {
                    updateStatus(uiId, `生成中: ${curProgress}%`, curProgress);
                }
            } catch (e) { console.error("轮询失败", e); }
        }, 4000);
    }

    // --- UI 渲染 ---
    function setBtnLoading(l) { isRendering = l; const b = document.getElementById('renderBtn'); b.disabled = l; b.innerText = l ? "正在提交..." : "开始生成"; b.classList.toggle('opacity-50', l); }
    function createTaskCard(id, p) {
        document.getElementById('taskQueue').insertAdjacentHTML('afterbegin', `
            <div id="${id}" class="bg-white p-4 rounded-xl shadow-sm border history-item">
                <p class="text-[10px] text-gray-500 truncate mb-2">${p}</p>
                <div class="prog-area">
                    <div class="flex justify-between text-[10px] mb-1 font-bold text-orange-600">
                        <span class="st-txt"><i class="fas fa-spinner loading-spin mr-1"></i>准备中</span>
                        <span class="pct-txt">0%</span>
                    </div>
                    <div class="w-full bg-gray-100 h-1 rounded-full overflow-hidden">
                        <div class="progress-fill h-full bg-orange-500 w-0"></div>
                    </div>
                </div>
                <div class="video-area hidden mt-2"></div>
            </div>`);
    }
    function updateStatus(id, msg, pct, type='') {
        const el = document.getElementById(id);
        if(!el) return;
        el.querySelector('.st-txt').innerText = msg;
        el.querySelector('.pct-txt').innerText = pct + '%';
        el.querySelector('.progress-fill').style.width = pct + '%';
        if(type === 'error') el.querySelector('.st-txt').classList.replace('text-orange-600', 'text-red-500');
    }
    function showVideo(id, url) {
        const el = document.getElementById(id);
        el.querySelector('.prog-area').classList.add('hidden');
        const area = el.querySelector('.video-area');
        area.innerHTML = `<video src="${url}" controls class="w-full rounded bg-black"></video>`;
        area.classList.remove('hidden');
    }
    function renderHistory() { videoHistory.forEach(h => { createTaskCard(h.id, h.prompt); showVideo(h.id, h.url); }); }
    function saveHist(prompt, url) { const h = { id: 'h-'+Date.now(), prompt, url }; videoHistory.unshift(h); localStorage.setItem('sora_hist', JSON.stringify(videoHistory.slice(0,10))); }
    function clearHistory() { localStorage.clear(); location.reload(); }
    async function parseStream(r) { 
        const t = await r.text(); 
        try { return JSON.parse(t); } catch(e) { 
            const lines = t.trim().split('\n'); 
            for(let l of lines) if(l.startsWith('data:')) return JSON.parse(l.replace('data:', ''));
        }
        return null;
    }
</script>
</body>
</html>
