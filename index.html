<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sora2 创作中心 - 参考图增强版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 旋转动画 */
        .loading-spin { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        /* 进度条平滑过渡动画 */
        .progress-fill { transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        /* 历史记录卡片滑入动画 */
        .history-item { animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* 图片预览区域过渡 */
        #refImagePreviewArea { transition: all 0.3s ease; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 font-sans">

    <header class="bg-orange-600 p-4 text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold"><i class="fas fa-video mr-2"></i>Sora2 创作中心</h1>
            <div class="text-[10px] bg-orange-800 px-2 py-1 rounded flex items-center">
                <i class="fas fa-save mr-1"></i> 本地自动保存已开启
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 lg:p-8 grid grid-cols-1 lg:grid-cols-12 gap-8">
        <section class="lg:col-span-3 space-y-4">
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-gray-100">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="font-bold text-gray-700">常用角色 (自动保存)</h2>
                    <button onclick="toggleAddChar()" class="text-orange-600 text-sm font-bold hover:bg-orange-50 px-2 py-1 rounded">+ 新增</button>
                </div>
                <div id="charList" class="grid grid-cols-2 gap-3 mb-4 min-h-[100px]"></div>
                
                <div id="addCharForm" class="hidden border-t pt-4 space-y-3">
                    <input type="text" id="newCharId" placeholder="角色ID (例如: Lily)" class="w-full p-2 border rounded text-sm outline-none focus:border-orange-500">
                    <div class="flex items-center justify-center w-full">
                        <label for="newCharImg" class="flex flex-col items-center justify-center w-full h-24 border-2 border-gray-300 border-dashed rounded-lg cursor-pointer bg-gray-50 hover:bg-gray-100">
                            <div class="flex flex-col items-center justify-center pt-5 pb-6 text-gray-400">
                                <i class="fas fa-cloud-upload-alt mb-2"></i>
                                <p class="text-xs">点击上传角色头像</p>
                            </div>
                            <input type="file" id="newCharImg" accept="image/*" class="hidden">
                        </label>
                    </div>
                    <button onclick="saveCharToLocal()" class="w-full bg-orange-600 hover:bg-orange-700 text-white py-2 rounded text-sm font-bold transition-colors">保存角色</button>
                </div>
            </div>
            <button onclick="clearHistory()" class="w-full text-xs text-gray-400 hover:text-red-500 transition-colors flex items-center justify-center">
                <i class="fas fa-trash-alt mr-1"></i> 清空所有本地记录
            </button>
        </section>

        <section class="lg:col-span-5 space-y-6">
            <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-400 mb-2 uppercase">API KEY (必填)</label>
                    <input type="password" id="apiKey" placeholder="在此输入您的 Bearer Token" class="w-full p-3 border rounded-xl text-sm focus:ring-2 focus:ring-orange-500 outline-none transition-all">
                </div>
                <div class="mb-4">
                    <label class="block text-xs font-bold text-gray-400 mb-2 uppercase">提示词 (点击左侧角色可快速插入)</label>
                    <textarea id="prompt" rows="6" class="w-full p-4 border rounded-xl text-sm focus:ring-2 focus:ring-orange-500 outline-none transition-all resize-none" placeholder="描述你的视频场景... 例如：一个穿着宇航服的 @Lily 在月球上行走。"></textarea>
                </div>

                <div class="mb-6">
                    <label class="block text-xs font-bold text-gray-400 mb-2 uppercase">上传参考底图 (可选)</label>
                    
                    <div id="refImageUploadBtn" class="flex items-center justify-center w-full">
                        <label for="refInput" class="flex flex-col items-center justify-center w-full h-20 border-2 border-gray-200 border-dashed rounded-xl cursor-pointer bg-gray-50 hover:bg-orange-50 hover:border-orange-300 transition-all group">
                            <div class="flex items-center justify-center text-gray-400 group-hover:text-orange-500">
                                <i class="fas fa-image mr-2"></i>
                                <p class="text-xs">点击选择图片 (用于辅助构图或风格)</p>
                            </div>
                            <input type="file" id="refInput" accept="image/*" class="hidden" onchange="handleRefImageSelect(event)">
                        </label>
                    </div>

                    <div id="refImagePreviewArea" class="hidden mt-3 p-2 border rounded-xl bg-gray-50 relative group">
                        <div class="flex items-center">
                            <img id="refPreviewImg" src="" class="w-16 h-16 object-cover rounded-lg border border-gray-200 bg-white">
                            <div class="ml-3 flex-1 overflow-hidden">
                                <p class="text-xs font-bold text-gray-700 truncate">已选用参考图</p>
                                <p class="text-[10px] text-gray-400 truncate" id="refFileName">filename.jpg</p>
                            </div>
                        </div>
                        <button onclick="clearRefImage()" class="absolute top-2 right-2 bg-white text-gray-400 hover:text-red-500 hover:bg-red-50 border border-gray-200 rounded-full w-6 h-6 flex items-center justify-center transition-all shadow-sm" title="清除参考图">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <select id="aspectRatio" class="p-3 border rounded-xl text-sm outline-none focus:border-orange-500 bg-white">
                        <option value="16:9">横屏 16:9</option>
                        <option value="9:16">竖屏 9:16</option>
                        <option value="1:1">方形 1:1</option>
                    </select>
                    <select id="duration" class="p-3 border rounded-xl text-sm outline-none focus:border-orange-500 bg-white">
                        <option value="5">时长 5s</option>
                        <option value="10" selected>时长 10s</option>
                        <option value="15">时长 15s</option>
                    </select>
                </div>
                <button onclick="startRender()" id="renderBtn" class="w-full bg-slate-900 hover:bg-black text-white font-bold py-4 rounded-2xl shadow-xl hover:shadow-2xl transition-all flex justify-center items-center group">
                    <span id="btnText">开始生成视频</span>
                    <i class="fas fa-rocket ml-2 group-hover:translate-x-1 transition-transform"></i>
                </button>
            </div>
        </section>

        <section class="lg:col-span-4">
            <div class="flex items-center justify-between mb-4">
                 <h2 class="text-sm font-bold text-gray-400 uppercase tracking-widest">任务队列 & 历史记录</h2>
                 <span class="text-[10px] text-gray-400 bg-gray-100 px-2 py-1 rounded-full">自动保存中</span>
            </div>
           
            <div id="taskQueue" class="space-y-4 pb-8">
                </div>
        </section>
    </main>

<script>
    // ================= 配置项 =================
    const API_HOST = "https://grsaiapi.com";
    const STORAGE_KEY_CHARS = 'sora_v6_chars';
    const STORAGE_KEY_HISTORY = 'sora_v6_history';

    // ================= 数据初始化 =================
    let myCharacters = JSON.parse(localStorage.getItem(STORAGE_KEY_CHARS) || '[]');
    let videoHistory = JSON.parse(localStorage.getItem(STORAGE_KEY_HISTORY) || '[]');
    // 新增：当前选中的参考图 Base64 数据
    let currentRefImageBase64 = null; 

    document.addEventListener('DOMContentLoaded', () => {
        renderCharacters();
        renderHistory();
    });

    // ================= 通用图片处理工具 =================
    // 读取并压缩图片，返回 Promise<Base64字符串>
    function handleImageUpload(file, maxSize = 300, quality = 0.8) {
        return new Promise((resolve, reject) => {
            if (!file || !file.type.startsWith('image/')) {
                reject('请选择有效的图片文件');
                return;
            }
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    let width = img.width;
                    let height = img.height;
                    // 等比缩放逻辑
                    if (width > height) { if (width > maxSize) { height *= maxSize / width; width = maxSize; } }
                    else { if (height > maxSize) { width *= maxSize / height; height = maxSize; } }
                    canvas.width = width; canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', quality));
                };
                img.onerror = () => reject('图片加载失败');
            };
            reader.onerror = () => reject('文件读取失败');
        });
    }

    // ================= 参考图功能逻辑 (新增) =================
    async function handleRefImageSelect(event) {
        const file = event.target.files[0];
        if (!file) return;

        const uploadBtn = document.getElementById('refImageUploadBtn');
        const previewArea = document.getElementById('refImagePreviewArea');
        const previewImg = document.getElementById('refPreviewImg');
        const fileNameTxt = document.getElementById('refFileName');

        try {
            // 显示加载状态（可选优化）
            fileNameTxt.innerText = '正在处理...';
            // 使用通用函数压缩图片 (稍微大一点，例如 500px)
            currentRefImageBase64 = await handleImageUpload(file, 500, 0.85);
            
            // 更新 UI 显示预览
            previewImg.src = currentRefImageBase64;
            fileNameTxt.innerText = file.name;
            uploadBtn.classList.add('hidden');
            previewArea.classList.remove('hidden');

        } catch (error) {
            alert("参考图处理失败: " + error);
            clearRefImage();
        }
        // 清空 input value，确保下次选择同一文件能触发 onchange
        event.target.value = '';
    }

    function clearRefImage() {
        currentRefImageBase64 = null;
        document.getElementById('refImageUploadBtn').classList.remove('hidden');
        document.getElementById('refImagePreviewArea').classList.add('hidden');
        document.getElementById('refPreviewImg').src = '';
    }

    // ================= 角色管理功能 =================
    function toggleAddChar() { 
        const form = document.getElementById('addCharForm');
        form.classList.toggle('hidden');
        if (!form.classList.contains('hidden')) document.getElementById('newCharId').focus();
    }
    function insertChar(id) { document.getElementById('prompt').value += ` @${id} `; document.getElementById('prompt').focus(); }

    function renderCharacters() {
        const list = document.getElementById('charList');
        if (myCharacters.length === 0) {
            list.innerHTML = '<div class="col-span-2 text-center text-xs text-gray-400 py-4 border-2 border-dashed rounded-xl">暂无角色，请点击新增</div>';
            return;
        }
        list.innerHTML = myCharacters.map((char, index) => `
            <div class="relative group border rounded-xl p-2 text-center hover:border-orange-500 cursor-pointer bg-white transition-all shadow-sm hover:shadow-md" onclick="insertChar('${char.id}')">
                <div class="w-full aspect-square rounded-lg mb-2 overflow-hidden bg-gray-100">
                    <img src="${char.avatar}" class="w-full h-full object-cover group-hover:scale-110 transition-transform duration-300">
                </div>
                <div class="text-xs font-bold truncate text-gray-700 bg-gray-50 rounded-md py-1">@${char.id}</div>
                <button onclick="deleteChar(event, ${index})" class="absolute -top-2 -right-2 bg-white text-red-500 border border-red-200 rounded-full w-5 h-5 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 transition-opacity shadow-sm hover:bg-red-50"><i class="fas fa-times"></i></button>
            </div>
        `).join('');
    }

    // 保存角色 (使用通用图片处理函数)
    async function saveCharToLocal() {
        const charIdInput = document.getElementById('newCharId');
        let charId = charIdInput.value.trim().replace(/^@+/, '').replace(/\s+/g, '_');
        const imgFile = document.getElementById('newCharImg').files[0];
        if (!charId) return alert("请填写角色ID");
        if (myCharacters.some(c => c.id === charId)) return alert("该角色ID已存在");
        
        try {
            // 角色头像压缩得小一点 (200px)
            const avatarBase64 = await handleImageUpload(imgFile, 200, 0.7);
            myCharacters.push({ id: charId, avatar: avatarBase64 });
            localStorage.setItem(STORAGE_KEY_CHARS, JSON.stringify(myCharacters));
            renderCharacters(); toggleAddChar();
            charIdInput.value = ''; document.getElementById('newCharImg').value = '';
        } catch (error) {
             alert(error);
        }
    }
    function deleteChar(e, index) { e.stopPropagation(); if(confirm('确定删除?')) { myCharacters.splice(index, 1); localStorage.setItem(STORAGE_KEY_CHARS, JSON.stringify(myCharacters)); renderCharacters(); } }

    // ================= 历史记录 & 核心生成逻辑 =================
    function renderHistory() { videoHistory.forEach(item => { if (!document.getElementById(item.id)) appendFinishedCard(item.id, item.prompt, item.url, item.time, true); }); }
    function saveVideoToHistory(prompt, url) {
        videoHistory.unshift({ id: 'hist-' + Date.now(), prompt, url, time: new Date().toLocaleString() });
        if (videoHistory.length > 20) videoHistory.pop();
        localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(videoHistory));
    }
    function clearHistory() { if(confirm("确定清空所有数据?")) { localStorage.clear(); location.reload(); } }

    let isRendering = false;
    async function startRender() {
        if (isRendering) return;
        const promptText = document.getElementById('prompt').value.trim();
        const key = document.getElementById('apiKey').value.trim();
        if (!promptText || !key) return alert("请填写提示词和API KEY");

        setRenderButtonState(true);
        const uiId = 'task-' + Date.now();
        createTaskCard(uiId, promptText);

        try {
            // 构建请求体
            const payload = {
                model: "sora-2", 
                prompt: promptText,
                aspectRatio: document.getElementById('aspectRatio').value,
                duration: parseInt(document.getElementById('duration').value)
            };

            // *** 核心修改：如果存在参考图，添加到请求体中 ***
            // 注意：这里假设 API 接收字段名为 'reference_image' 或 'image_url'，请根据实际 API 文档调整
            if (currentRefImageBase64) {
                payload.reference_image = currentRefImageBase64; 
                // 或者如果 API 需要 image_url 字段:
                // payload.image_url = currentRefImageBase64;
                console.log("已添加参考图到请求 payload");
            }

            const resp = await fetch(`${API_HOST}/v1/video/sora-video`, {
                method: 'POST',
                headers: { 'Authorization': `Bearer ${key}`, 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await parseApiResponse(resp);
            if (!resp.ok) throw new Error(data?.msg || "提交失败");
            const taskId = data.data?.id || data.id;
            if (!taskId) throw new Error("未获取到任务ID");

            updateTaskStatus(uiId, { msg: `已受理 (ID: ${taskId.slice(-6)})`, progress: 5 });
            pollTaskStatus(taskId, uiId, key, promptText);
            
            // 提交成功后，清空参考图选择，避免下次误用
            clearRefImage();

        } catch (e) {
            updateTaskStatus(uiId, { msg: "提交失败: " + e.message, type: 'error' });
            setRenderButtonState(false);
        }
    }

    // 轮询逻辑 (保持不变，省略部分代码以节省篇幅，功能与上一版一致)
    async function pollTaskStatus(taskId, uiId, key, originalPrompt) {
        let errorCount = 0;
        const timer = setInterval(async () => {
            try {
                const resp = await fetch(`${API_HOST}/v1/draw/result`, { method: 'POST', headers: { 'Authorization': `Bearer ${key}`, 'Content-Type': 'application/json' }, body: JSON.stringify({ id: taskId }) });
                const res = await parseApiResponse(resp);
                if (!res || !res.data) return;
                const status = res.data.status;
                let progress = Math.max(0, Math.min(99, parseInt(res.data.progress) || 0));

                if (status === 'succeeded' || status === 'success') {
                    clearInterval(timer); setRenderButtonState(false);
                    updateTaskStatus(uiId, { msg: '生成完成', type: 'success', progress: 100 });
                    const videoUrl = res.data.results?.[0]?.url || res.data.url;
                    if (videoUrl) { saveVideoToHistory(originalPrompt, videoUrl); showFinishedVideo(uiId, videoUrl); }
                } else if (status === 'failed') {
                    clearInterval(timer); setRenderButtonState(false);
                    updateTaskStatus(uiId, { msg: "失败: " + (res.data.failure_reason || "未知"), type: 'error' });
                } else {
                    errorCount = 0;
                    updateTaskStatus(uiId, { msg: progress > 0 ? `生成中...` : `排队中...`, type: 'loading', progress: progress });
                }
            } catch (e) {
                if (++errorCount > 10) { clearInterval(timer); setRenderButtonState(false); updateTaskStatus(uiId, { msg: "网络中断", type: 'error' }); }
            }
        }, 3000);
    }

    // UI 辅助函数 (保持不变)
    function createTaskCard(id, prompt) {
        document.getElementById('taskQueue').insertAdjacentHTML('afterbegin', `
            <div id="${id}" class="bg-white rounded-2xl border border-gray-200 shadow-sm overflow-hidden history-item transition-all">
                <div class="p-4 pb-3 bg-gray-50 border-b border-gray-100 flex justify-between"><p class="text-xs text-gray-600 line-clamp-2 font-medium flex-1 mr-2">${prompt}</p><span class="time-tag text-[10px] text-gray-400">${new Date().toLocaleTimeString()}</span></div>
                <div class="p-4 processing-container"><div class="flex items-center justify-between text-xs mb-2 font-bold"><div class="status-text flex items-center text-orange-600"><i class="fas fa-circle-notch loading-spin mr-2"></i>准备中...</div><div class="progress-percent text-orange-600 font-extrabold">0%</div></div><div class="w-full bg-gray-100 h-2 rounded-full overflow-hidden"><div class="progress-fill h-full bg-gradient-to-r from-orange-400 to-orange-600 w-0 rounded-full"></div></div></div>
                <div class="video-area hidden bg-black relative group"></div>
            </div>`);
    }
    function updateTaskStatus(id, { msg, type = 'loading', progress = 0 }) {
        const card = document.getElementById(id); if (!card) return;
        const [statusEl, percentEl, fillEl, spinner] = [card.querySelector('.status-text'), card.querySelector('.progress-percent'), card.querySelector('.progress-fill'), card.querySelector('.loading-spin')];
        if (msg) statusEl.innerHTML = (type === 'loading' ? '<i class="fas fa-circle-notch loading-spin mr-2"></i>' : '') + msg;
        if (progress >= 0) { fillEl.style.width = `${progress}%`; percentEl.innerText = `${progress}%`; }
        if (type !== 'loading') {
            const color = type === 'error' ? 'red-500' : 'green-600';
            statusEl.classList.replace('text-orange-600', `text-${color}`); percentEl.classList.replace('text-orange-600', `text-${color}`);
            fillEl.className = `progress-fill h-full bg-${color === 'red-500' ? 'red' : 'green'}-500 w-0 rounded-full`;
            if (spinner) spinner.remove();
            if (type === 'success') statusEl.innerHTML = '<i class="fas fa-check-circle mr-2"></i>成功';
        }
    }
    function appendFinishedCard(id, prompt, url, timeStr, isHistory=false) { createTaskCard(id, prompt); document.getElementById(id).querySelector('.time-tag').innerText=timeStr+(isHistory?'(历史)':''); updateTaskStatus(id,{msg:'完成',type:'success',progress:100}); showFinishedVideo(id,url); }
    function showFinishedVideo(id, url) { const c=document.getElementById(id); c.querySelector('.processing-container').classList.add('hidden'); c.querySelector('.video-area').innerHTML=`<video src="${url}" controls class="w-full aspect-video object-contain"></video><div class="absolute top-2 right-2 flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity"><button onclick="window.open('${url}')" class="bg-black/50 text-white p-2 rounded-full text-xs"><i class="fas fa-external-link-alt"></i></button></div>`; c.querySelector('.video-area').classList.remove('hidden'); }
    function setRenderButtonState(l) { isRendering=l; const b=document.getElementById('renderBtn'); b.disabled=l; b.classList.toggle('opacity-70',l); document.getElementById('btnText').innerText=l?'提交中...':'开始生成视频'; b.querySelector('i').classList.toggle('hidden',l); }
    async function parseApiResponse(r) { try { const t=await r.text(); try{return JSON.parse(t)}catch(e){} const l=t.trim().split('\n'); for(let i=l.length-1;i>=0;i--) if(l[i].startsWith('data:')) try{return JSON.parse(l[i].substring(5).trim())}catch(e){} } catch(e){return null} }
</script>
</body>
</html>
